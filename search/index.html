---
permalink: /search/
layout: page
title: Search
---


<script>
  (() => {
    const RESULTS_LIMIT = 50;

    //////////////////////////////////
    // Rendering

    const renderResults = (results) => {
      const element = document.getElementById('search-results');

      if (!results.length) {
        element.innerHTML = renderResults_noResults();
      }
      else {
        element.innerHTML = `
          <ol>
            ${results.map(renderResults_result).join('')}
          </ol>
        `;
      }
    };

    const renderResults_noResults = () => {
      return `<h2 class="title">No results found</h2>`;
    };

    const renderResults_result = (result) => {
      return `
        <li>
          <a href="${result.url}">
            <h2 class="title">${highlight(result.title)}</h2>
            <p>${highlight(result.description)}... <span class="read-more">Continue reading</span></p>
          </a>
        </li>
      `;
    };

    const highlight = (text) => {
      return text.replace(/\uE000/g, '<span class="bg-yellow">').replace(/\uE001/g, '</span>');
    };

    //////////////////////////////////
    // Translation

    const translate_fromSearchGov = (response) => {
      return response.web.results.map(result => {
        return {
          url: result.url,
          title: result.title,
          description: result.snippet
        };
      });
    };

    const translate_fromSearchJson = (response) => {
      const smartTruncate = (text, targetLength) => {
        if (text.length < targetLength) {
          return text;
        }

        const regex = new RegExp(`^.{${targetLength}}[^ ]*`);
        return regex.exec(text)[0];
      };

      return response.slice(0, RESULTS_LIMIT).map(result => {
        return {
          url: result.item.url,
          title: result.item.title,
          description: smartTruncate(result.item.content, 300),
        };
      });
    }

    //////////////////////////////////
    // Performing search

    const search_searchGov = (query) => new Promise((resolve, reject) => {
      const searchEndpoint = new URL('{{site.searchgov.endpoint}}/api/v2/search/i14y');
      const searchTimeout = 3; // seconds

      reject(new Error('Not an error, debugging locally.'));

      window.setTimeout(() => {
        reject(new Error(`Request for search.gov results timed out after ${searchTimeout} seconds.`));
      }, searchTimeout * 1000);

      Object.entries({
        affiliate: '{{site.searchgov.affiliate}}',
        access_key: '{{site.searchgov.access_key}}',
        query: query,
        limit: RESULTS_LIMIT
      }).forEach(([key, value]) => searchEndpoint.searchParams.append(key, value));

      const searchgov = fetch(searchEndpoint)
        .then(response => response.json());

      searchgov.catch(reject);

      searchgov
        .then(translate_fromSearchGov)
        .then(resolve);
    });

    const search_local = (query) => new Promise((resolve, reject) => {
      const searchjson = fetch("{{ site.baseurl }}/search.json")
        .then(response => response.json());

      searchjson.catch(reject);

      searchjson
        .then(pages => {
          return new Fuse(pages, {
            keys: [ "title", "excerpt", "content" ]
          }).search(query);
        })
        .then(translate_fromSearchJson)
        .then(resolve);
    });

    const query = new URLSearchParams(window.location.search).get('query');

    window.addEventListener('DOMContentLoaded', () => {
      search_searchGov(query)
        .then(renderResults)
        .catch(error => {
          console.warn('Using local search fallback.', error);
          search_local(query)
            .then(renderResults);
        });
    });
  })();
</script>

<h1>Search Results</h1>

<div id="search-results"></div>
